name: Create review app

on:
  workflow_call:
    inputs:
      name:
        required: true
        type: string
      service:
        required: true
        type: string
      base_deploy_id:
        required: true
        type: string
    secrets:
      do_token:
        required: true
      service_spec:
        required: false

jobs:
  create-review-app:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout administration
        uses: actions/checkout@v2
        with:
          repository: Animately/administration
          token: ${{ github.token }}

      - name: Install do-spec
        run: cd do-spec; npm install && npm install -g .

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.do_token }}

      - name: Login to registry
        run: doctl registry login

      - name: Generate app-spec.json from doctl
        run: |
          doctl apps spec get ${{ inputs.base_deploy_id }} --format json > app-spec.json

      - name: Generate app-replace.json from inputs
        env:
          REVIEW_NAME: ${{ inputs.name }}
          SERVICE_NAME: ${{ inputs.service }}
        run: |
          cat <<EOT>> app-replace.json
          { "name": "$SERVICE_NAME-$REVIEW_NAME" }
          EOT

      - name: Remove domain settings (use DO domain)
        run: |
          echo "$(do-spec delete-top-level-props app-spec.json domains)" > app-spec.json 

      - name: Merge app-replace.json into app-spec.json
        run: |
          echo "$(do-spec merge-top-level app-spec.json app-replace.json)" > app-spec.json

      - name: Determine presence of service_spec
        id: service_spec_check
        if: ${{ env.SERVICE_SPEC != '' }}
        env:
          SERVICE_SPEC: ${{ secrets.service_spec }}
        run: echo "::set-output name=defined::true"

      - name: Get other services
        id: extract_services
        run: |
          service_list=$(echo "console.log(require('./app-spec.json').services.filter(s => s.name !== '${{ inputs.service }}').map(s => s.name).join(', '))" | node -)
          echo "::set-output name=services::$service_list"

      - name: Remove other services from spec
        run: |
          echo "$(do-spec delete-services app-spec.json ${{ steps.extract_services.outputs.services }})" > app-spec.json

      - name: Generate service spec
        if: ${{ steps.service_spec_check.outputs.defined == 'true' }}
        shell: bash
        run: echo -e '${{ secrets.service_spec }}' > service-spec.json

      - name: Merge service spec into app-spec.json
        if: ${{ steps.service_spec_check.outputs.defined == 'true' }}
        run: |
          echo "$(do-spec merge-service app-spec.json ${{ inputs.service }} service-spec.json)" > app-spec.json

      - name: Deploy new review app to digitalocean
        run: doctl apps create --wait --spec app-spec.json

      - name: Clean up
        run: |
          rm app-spec.json 
          rm app-replace.json 
          rm service-spec.json 
